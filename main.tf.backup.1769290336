resource "azurerm_resource_group" "aks_primary" {
  name     = "aks-primary_group"
  location = "eastus"
}

resource "azurerm_kubernetes_cluster" "aks_primary" {
  name                = "aks-primary"
  location            = azurerm_resource_group.aks_primary.location
  resource_group_name = azurerm_resource_group.aks_primary.name
  dns_prefix          = "aks-primary-dns"

  default_node_pool {
    name           = "aksprimary"
    vm_size        = "Standard_DC2ads_v5"
    node_count     = 1
    vnet_subnet_id = "/subscriptions/704a6e87-98bd-489c-8e67-1317c8bfc787/resourceGroups/DefaultResourceGroup-EUS/providers/Microsoft.Network/virtualNetworks/vnet-primary/subnets/aks-subnet"
  }

  identity {
    type = "SystemAssigned"
  }

  lifecycle {
    ignore_changes = [
      # API server settings
      api_server_access_profile,
      api_server_authorized_ip_ranges,

      # Image management
      image_cleaner_enabled,
      image_cleaner_interval_hours,

      # Identity & security
      oidc_issuer_enabled,
      workload_identity_enabled,
      azure_policy_enabled,
      automatic_channel_upgrade,

      # Node pool settings
      default_node_pool[0].zones,
      default_node_pool[0].enable_auto_scaling,
      default_node_pool[0].max_count,
      default_node_pool[0].min_count,
      default_node_pool[0].upgrade_settings,

      # Maintenance
      maintenance_window_auto_upgrade,
      maintenance_window_node_os,

      # Network
      network_profile,

      # Tags
      tags
    ]
  }
}

resource "azurerm_postgresql_flexible_server" "primary" {
  name                   = "postgresqlprimary"
  resource_group_name    = azurerm_resource_group.aks_primary.name
  location               = "westus"
  version                = "16"
  administrator_login    = "zaheeradmin"
  administrator_password = "Hooria1234"
  storage_mb             = 32768
  sku_name               = "GP_Standard_D2s_v3"
  zone                   = "1"

  lifecycle {
    ignore_changes = [
      version,
      administrator_password,
      sku_name,
      zone,
      tags
    ]
  }
}

resource "azurerm_postgresql_flexible_server" "dr_replica" {
  name                   = "postgresql-dr-replica"
  resource_group_name    = azurerm_resource_group.aks_primary.name
  location               = "westus"
  version                = "16"
  administrator_login    = "zaheeradmin"
  administrator_password = "Hooria1234"
  storage_mb             = 32768
  sku_name               = "GP_Standard_D2s_v3"
  zone                   = "1"

  lifecycle {
    ignore_changes = [
      version,
      administrator_password,
      sku_name,
      zone,
      tags
    ]
  }
}

resource "azurerm_storage_account" "azure_primary" {
  name                     = "azureprimarystorage"
  resource_group_name      = azurerm_resource_group.aks_primary.name
  location                 = "centralus"
  account_tier             = "Standard"
  account_replication_type = "RAGRS"
  account_kind             = "StorageV2"
  access_tier              = "Hot"

  allow_nested_items_to_be_public  = false
  cross_tenant_replication_enabled = false

  tags = {
    "ms-resource-usage" = "azure-cloud-shell"
  }
}

resource "azurerm_storage_account" "velero" {
  name                     = "velerobackupforprimary"
  resource_group_name      = azurerm_resource_group.aks_primary.name
  location                 = "eastus"
  account_tier             = "Standard"
  account_replication_type = "RAGRS"
  account_kind             = "StorageV2"
  access_tier              = "Hot"

  allow_nested_items_to_be_public  = false
  cross_tenant_replication_enabled = false
}

resource "azurerm_virtual_network" "vnet" {
  name                = "vnet-primary"
  resource_group_name = azurerm_resource_group.aks_primary.name
  location            = "eastus"
  address_space       = ["10.0.0.0/16"]
}
